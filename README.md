# Dekorum Telegram Bot

Цей репозиторій містить Telegram-бота з підтримкою webhook і інтеграцією LiqPay для прийому платежів.

## Функціональність

- **Webhook:** Бот працює через вебхук – Telegram надсилає оновлення (повідомлення від користувачів) на наш серверний застосунок (URL вебхука).
- **Оплата через LiqPay:** По команді `/start` бот відправляє повідомлення з кнопкою оплати. Натиснувши кнопку, користувач перейде на захищену сторінку LiqPay для оплати **490 UAH**. 
- **Підтвердження оплати:** Після успішної оплати LiqPay викликає наш callback URL на сервері. Бот перевіряє підпис повідомлення від LiqPay і надсилає користувачу повідомлення з підтвердженням отримання коштів.

## Налаштування

1. **Змінні середовища:** Створіть файл `.env` (або налаштуйте змінні середовища на хостингу) та визначте такі ключі:
   - `BOT_TOKEN` – токен вашого Telegram-бота (отриманий від BotFather).
   - `LIQPAY_PUBLIC_KEY` – публічний ключ LiqPay (з кабінету LiqPay).
   - `LIQPAY_PRIVATE_KEY` – приватний ключ LiqPay.
   - `DOMAIN` – домен, на якому запущений сервер (для webhook і LiqPay callback). **На Render це посилання на ваш додаток, наприклад, `https://dekorum-bot.onrender.com`.**
   - `WEBHOOK_PATH` – шлях для webhook запиту Telegram (повинен співпадати з налаштуванням в коді і буде використовуватись при встановленні webhook).
   - Інші параметри: `CURRENCY` (валюта, напр. UAH), `PAY_AMOUNT` (сума до сплати, напр. 490).
2. **Встановлення залежностей:** Виконайте `pip install -r requirements.txt` (рекомендується використовувати Python 3.9+).
3. **Запуск локально:** Для локального тестування необхідно забезпечити доступність вашого застосунку за HTTPS з інтернету (Telegram вимагає валідний HTTPS). Ви можете використати сервіси типу ngrok для проксірування локального сервера. Після налаштування тунелю, встановіть `DOMAIN` на URL тунелю і запустіть застосунок: `uvicorn server:app --host 0.0.0.0 --port 8443`. *Примітка:* локальне тестування webhook без HTTPS складне, тому простіше розгорнути на сервері або платформі типу Render.
4. **Розгортання на Render:** 
   - Створіть новий Web Service на [Render](https://render.com). 
   - Підключіть репозиторій з кодом бота.
   - У налаштуваннях сервісу додайте змінні середовища (`BOT_TOKEN`, `LIQPAY_PUBLIC_KEY`, `LIQPAY_PRIVATE_KEY`, `DOMAIN` (значення збігається з URL вашого сервісу на Render), `WEBHOOK_PATH`, тощо).
   - Deploy запуститься автоматично. Після першого запуску бот встановить webhook на вказаний `DOMAIN`+`WEBHOOK_PATH`. Переконайтеся, що `DOMAIN` співпадає з фактичним доменом додатку (Render надає домен формату `<your-app>.onrender.com`).
5. **Перевірка роботи:** Відкрийте діалог з вашим ботом у Telegram та надішліть команду `/start`. Бот має відповісти вітальним повідомленням з кнопкою для оплати. Натисніть кнопку – ви будете перенаправлені на LiqPay для проведення тестового платежу. 
   - Якщо оплата успішна, LiqPay виконає callback на наш сервер: ви повинні отримати повідомлення в Telegram від бота про підтвердження оплати (наприклад: "Платіж на суму 490 UAH отримано, статус: success").

## Додаткова інформація

- Код бота написаний з використанням асинхронної бібліотеки **python-telegram-bot v20**. Обробка повідомлень через webhook реалізована згідно з рекомендаціями документації: запити Telegram надходять на URL і переводяться в об'єкт `Update`, який передається в чергу для обробки ботом:contentReference[oaicite:4]{index=4}.
- Формування платіжної URL для LiqPay здійснюється відповідно до [документації LiqPay](https://www.liqpay.ua/documentation/api/aquire/checkout/doc) шляхом створення JSON з параметрами платежу і генерування підпису на основі приватного ключа:contentReference[oaicite:5]{index=5}:contentReference[oaicite:6]{index=6}. Згенерований параметр `data` та підпис додаються до URL `https://www.liqpay.ua/api/3/checkout` для переадресації користувача.
- В середовищі Render бот працює постійно, очікуючи на повідомлення. Завдяки webhook, нові повідомлення доставляються миттєво, без потреби опитування (polling):contentReference[oaicite:7]{index=7}.
- **Безпека:** Webhook URL містить унікальний шлях (`securehook_...`), що підвищує безпеку. Дані LiqPay callback перевіряються на автентичність шляхом верифікації цифрового підпису, сформованого з використанням вашого приватного ключа.
- Перед запуском у продакшн, переконайтеся, що ви **не зберігаєте приватні ключі в репозиторії** публічно. На Render варто використовувати секцію **Environment Variables** для зберігання токену бота та ключів LiqPay.

